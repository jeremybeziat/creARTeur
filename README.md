<p align="center">
  <a href="" rel="noopener">
 <img width=200px height=200px src="https://i.imgur.com/6wj0hh6.jpg" alt="Project logo"></a>
</p>

<h3 align="center">RESTful API</h3>

<div align="center">

[![Status](https://img.shields.io/badge/status-active-success.svg)]()
[![GitHub Issues](https://img.shields.io/github/issues/kylelobo/The-Documentation-Compendium.svg)](https://github.com/kylelobo/The-Documentation-Compendium/issues)
[![GitHub Pull Requests](https://img.shields.io/github/issues-pr/kylelobo/The-Documentation-Compendium.svg)](https://github.com/kylelobo/The-Documentation-Compendium/pulls)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](/LICENSE)

</div>

---

<p align="center"> Projet certifiant des √©tudiants de Castres.
    <br> 
</p>

## Sommaire

- [üìù Sommaire](#-table-of-contents)
- [üõ´ Pour commencer](#-about-)
  - [ü™° Pr√©requis](#-getting-started-)
  - [üñ•Ô∏è Installation](#prerequisites)
- [üôÜüèæ A vos marques...]()
- [ü§ñ Tests](#installing)
  - [üõ†Ô∏è Tests end to end](#-running-the-tests-)
  - [üíé Coding style]()
- [üèÉ Usage]()
- [üöÄ Deploiment]()
- [üß± Technologies]()
- [üë∑üèæ Auteurs]()
- [üéâ Remerciement]()
- [üîú La suite ?]()

## Pour commencer <a name = "about"></a>

Ce projet √† pour but d'encadrer la partie back-end du projet certifiants. Avec une API permettant **la connexion** et **l'historique de connexion**.

## Pr√©requis <a name = "getting_started"></a>

Vous pouvez clonez ce repos pour avoir le projet :
```bash
  git clone https://
```

o√π suivre ce ***README*** qui vous explique en d√©tails comment proc√©der.

- [Postman](https://www.postman.com/downloads/)
- [IDE](https://code.visualstudio.com/)
- [Web browser](https://www.youtube.com/watch?v=dQw4w9WgXcQ&ab_channel=RickAstley)
- [NPM](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm)
- [NodeJs](https://nodejs.org/en/)
- [MongoDB](https://www.mongodb.com/try/download/community?tck=docs_server)
- [Typescript](https://www.npmjs.com/package/ts-node)

### Installation

Pour installer mongoDB, ***suivez ses √©tapes*** :

1. Allez sur ce lien : [MongoDB](https://www.mongodb.com/try/download/community?tck=docs_server).
2. T√©l√©charger la version ***locale*** et le format ***msi***.
3. <p align="center">
  <a href="" rel="noopener">
 <img  height=200px src="./assets/img/mongo_version.png" alt="Project logo"></a>
</p>
4. Pour g√©rer vos bases de donn√©es plus facilement, t√©l√©charger Studio 3T.

### √Ä vos marques...

Cr√©er un r√©pertoire au nom de *ment*. Qui est l'acronyme des technologies que l'on va utiliser : MongoDB, Express, Node, TS.

```bash
  mkdir ment
```

Ouvrez ce r√©pertoire avec VSCode. Votre r√©pertoire sera vide.

Ex√©cuter la commande pour cr√©er un projet node.

***V√©rifier bien que votre version de node soit en 18 !!!***

```bash
  npm init
```

ou 

```bash
  yarn init
```

et remplissez les donn√©es de votre projet.

Voil√† √† quoi ressemble votre projet :

<p align="center">
  <a href="" rel="noopener">
 <img  height=200px src=""></a>
</p>

Installer les d√©pendances suivantes :

```bash
  npm install express zod config cors mongoose pino pino-pretty dayjs bcrypt jsonwebtoken lodash nanoid
```

Nous allons voir en √† quoi correspondent **chacune de ces d√©pendances**.  

Installer maintenant les ***d√©pendances dev*** qui ne seront pas utiles √† la production mais n√©cessaires au bon d√©veloppement de notre app.

```bash
  npm i @types/body-parser @types/config @types/cors @types/express @types/node @types/pino @types/mongoose @types/bcrypt @types/jsonwebtoken @types/lodash @types/nanoid ts-node-dev typescript -D
```

Cr√©er un r√©pertoire *src* √† la racine de votre projet.

```bash
  mkdir src
```

D√©placer vous dans le r√©pertoire src.

```bash
  cd src
```

Cr√©er un fichier *app.ts*.

```bash
  touch app.ts
```

Faites un console.log dans le app.ts.

```ts
  console.log('never gonna give you up')
```

Pour lancer le app.ts, cr√©er un script dans votre package.json.

```json
  "script":{
    "dev":"ts-node-dev --respawn --transpile-only src/app.ts"
  },
```


### Pr√™t ?

Commencer par importer express.

```ts
  import express from 'express';
```

Cr√©er une constante est lancer votre serveur sur le port de votre choix. Ce port est en dure mais sera mis dans nos variables d'environement.


```ts
  const APP = express();

  APP.listen(3000, ()=>{
    console.log("üöÄ App is running")
  })
```

***ATTENTION ! Si vous avez une erreur √† ce stade, vous n'avez probablement pas rajouter ceci dans votre package.json***

```json
  "outDir":"build"
```

Vous devriez avoir un message dans votre terminal.

Maintenant, nous allons setup nos variables d'environnement.

Cr√©er un dossier config √† la racine du projet.

***ATTENTION ! V√©rifier bien que vous √™tes √† la racine avant d'ex√©cuter la commande***

```bash
  mkdir config
```

Dans le dossier config cr√©er un fichier default.ts.

```bash
  cd config && touch default.ts
```

Dans le fichier :

```ts
  export default {
    port:  <port_de_votre_choix>
  }
```

Revenez dans le app.ts et importer config.

```ts
  import config from 'config'
```

Pour utiliser le port :

```ts
  const PORT = config.get('port')
```

Nous allons utiliser le TS pour pouvoir typ√© nos variables et ainsi rendre notre application plus s√ªr.

```ts
const PORT = config.get<number>('port')
```

Il vous suffit de remplacer le port en dur dans le code par votre constante.

```ts
  app.listen(port, ()=>{
    console.log()
  })
```

## Partez !

Attaquons nous maintenant √† la base de donn√©es utilisateurs. Cr√©er un dossier database ***√† la dans votre dossier src de votre projet***.

Il est imp√©rative de v√©rifier que votre serveur mongo tourne. Ex√©cuter la commande suivante :

```bash
mongod
```

```bash
  mkdir database && cd database
```

Cr√©er un fichier qui nous servira d'interface de connexion √† notre base de donn√©es mongoDB.

```bash
  touch mongodb.ts
```

Importer l'ODM (Object Data Modeling) mongoose dans mongodb.ts et config.

```ts
  import mongoose from 'mongoose';
  import config from 'config';
```

D√©clarer et exporter la fonction connect.

```ts
  function connect() {
    //code here
  }

export default connect;
```

Installer √©galement [mongoDB compass](https://www.mongodb.com/try/download/compass), une bonne alternative √† studio 3T pour manager vos BDD.
Vous pouvez obtenir votre uri de base de donn√©e avec mongoDB compass, vous devez simplement rajouter le nom de votre db.


<p align="center">
  <a href="" rel="noopener">
 <img  height=200px src="./assets/mongodbcompass.png"></a>
</p>

Compl√©ter votre fonction afin d'initialiser une connection √† votre base de donn√©e mongoDB.

```ts
  async function connect() {
    const DBURI = 'mongodb://localhost:27017/ment_user';

    try {
      await mongoose.connect(DBURI)
      console.log('Connected to mongoDB')
    }
    catch(error:any) {
      console.log('Could not connect to mongoDB')
      process.exit(-1)
    }  
  }
```

Une fois la fonction cr√©e, exportez-la vers ***app.ts*** et appeler la dans le *listen*.

```ts
  import connect from '../database/mongodb';

  app.listen(port, async () => {
    console.log('App is running')
    await connect();
  })
```

Une fois que cela fonctionne, ***passez par le config*** pour obtenir l'URI de votre base de donn√©e. Comme vous l'avez fait pour le port. Remplacer cette ligne  dans le dossier mongodg.ts:

```ts
  const DBURI = "mongo://localhost:27017/db_name"
```

par 

```ts
  const DBURI = config.get<string>('mongodburi')
```

Vous obtiendrez ceci :

```ts
  import mongoose from 'mongoose'
  import config from 'config'

  async function connect() {
    const DBURI = config.get<string>('mongodburi')

    try {
      //connect
    }
    catch(error:any){
      //error
    }
  }
```

## Place au logger

On utilise pas mal de console log dans notre projet, ce qui n'est pas une mauvaise chose mais on peut am√©liorer cela.

Dans le dossier src de votre projet, cr√©er un dossier *utils*

```bash
  mkdir utils && cd utils
```

Cr√©er un fichier logger.ts

```bash
  touch logger.ts
```

Importer logger depuis le package *pino*. Puis dayjs depuis *dayjs*

```ts
  import logger from 'pino'
  import dayjs from 'dayjs'
```

Nous allons cr√©er notre premier logger gr√¢ce √† ces deux packages. Dayjs nous permet de manipuler la date plus facilement tandis que pino est notre logger.

```ts
  const LOG = logger({  
    base: {
      pid: false
    },
    timestamp: () => `,"time":"${dayjs().format()}"`
  })

  export default LOG
```

Importer le dans le *app.ts* et remplacer votre console.log.

```ts
  .
  .
  .
  import LOG from './utils/logger.ts'
  .
  .
  LOG.info(`üöÄ App is running at http://localhost:${PORT}`)
  LOG.error(`üî• App is crashing`)
```

***Remplacer tous vos console.log par  des logger !***

## Toutes les routes m√®ne √† ROM

Il est temps de designer notre API. ***Dans le dossier src du projet***, cr√©er un dossier *routes*.

```bash
  mkdir routes && cd routes
```

Les routes sont group√©s par leurs niveaux d'acc√®s : public et priv√©e. Cr√©er deux sous-dossier ./routes/public et .routes/private.

```bash
  mkdir public && mkdir private
```

Ensuite cr√©er un fichier dans le dossier public.

```bash
  cd public && touch openRoutes.ts
```

Ensuite cr√©er l'√©quivalent dans le dossier private.

```bash
  cd .. cd private && privateRoutes.ts
```

Le dossier routes va nous permettre de rediriger les requ√™tes HTTP vers le controlleur.

Dans le dossier public dans le fichier , cr√©er la function openRoutes().

```ts
  export function openRoutes() {
    //code here
  }
```

La fonction *openRoutes* prend en param√®tre une app de type **Express**.

```ts
  import { Express } from 'express';
  
  function openRoutes(app: Express){

  }
```

Exporter la function dans ***app.ts*** et v√©rifier qu'il n'y ai pas d'erreur.

```ts
  //dans le listen
  openRoutes(app)
```

Dans ***app.ts***, importer openRoutes.

Formater un votre app.ts √† l'aide d'un try catch de sorte que d√®s lors o√π vous avez une erreur, cela renvoie une erreur.

Nous allons donc d√©velopper notre premi√®re endpoint dans ***./routes/public***.

```ts
  import {Request, Response } from 'express'
  app.get('/healthcheck', (req: Request, res: Response)=>{
    res.status(200).send({'message': '‚úÖ'})
  })
```

Avant de cr√©er plus d'endpoint, nous allons cr√©er notre premier ***middleware***. 

Dans le dossier ***src***, cr√©er un dossier validate, puis cr√©er un fichier validateRessource.ts.

```bash
  mkdir validate && cd validate && touch valdiateRessource.ts
```

Ce middleware va nous valider nos requ√™tes. Par exemple, lorsque nous allons envoyer un utilisateur, faire en sorte que les donn√©es envoy√©es par l'utilisateur soit coh√©rent. Pour √ßa, nous allons utiliser [Zod](https://www.npmjs.com/package/zod).

```ts
  import { AnyZodObject } from 'zod'
  import { Request, Response, NextFunction } from 'express'

  const validate = (schema: AnyZodObject) => (req: Request, res:Response, next:NextFunction) => {
    try {
      schema.parse({
        body: req.body,
        query: req.query,
        params: req.params
      })
    } catch(error:any){
      return res.status(400).send(error.error)
    }
  }
  export default validate;
```

cette fonction prend en param√®tre un schema et regarde si tout les champs correspondent.

## Inscription utilisateur

Pour cr√©er des utilisateurs, il faut les mod√©liser en base de donn√©es.

Cr√©er dans le dossier src, un dossier *models*.

```bash
    mkdir models && cd models
```

Puis cr√©er un fichier user.model.ts.

```bash
  touch user.model.ts
```


## üîß Running the tests <a name = "tests"></a>

Explain how to run the automated tests for this system.

### Break down into end to end tests

Explain what these tests test and why

```
Give an example
```

### And coding style tests

Explain what these tests test and why

```
Give an example
```

## üéà Usage <a name="usage"></a>

Add notes about how to use the system.

## üöÄ Deployment <a name = "deployment"></a>

Add additional notes about how to deploy this on a live system.

## ‚õèÔ∏è Built Using <a name = "built_using"></a>

- [MongoDB](https://www.mongodb.com/) - Database
- [Express](https://expressjs.com/) - Server Framework
- [VueJs](https://vuejs.org/) - Web Framework
- [NodeJs](https://nodejs.org/en/) - Server Environment

## ‚úçÔ∏è Authors <a name = "authors"></a>

- [@kylelobo](https://github.com/kylelobo) - Idea & Initial work
- [EmericBayard]()

See also the list of [contributors](https://github.com/kylelobo/The-Documentation-Compendium/contributors) who participated in this project.

## üéâ Acknowledgements <a name = "acknowledgement"></a>

- Hat tip to anyone whose code was used
- Inspiration
- References